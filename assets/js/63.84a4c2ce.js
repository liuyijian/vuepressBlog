(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{491:function(t,e,a){"use strict";a.r(e);var s=a(15),r=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"chap5-ffmpeg-流媒体"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#chap5-ffmpeg-流媒体"}},[t._v("#")]),t._v(" Chap5 FFmpeg 流媒体")]),t._v(" "),a("h2",{attrs:{id:"ffmpeg发布与录制rtmp流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg发布与录制rtmp流"}},[t._v("#")]),t._v(" FFmpeg发布与录制RTMP流")]),t._v(" "),a("ul",[a("li",[t._v("RTMP是最常见的实时直播，为了防止错过精彩画面，考虑将RTMP流录制下来")])]),t._v(" "),a("h4",{attrs:{id:"rtmp参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rtmp参数说明"}},[t._v("#")]),t._v(" RTMP参数说明")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/0081Kckwly1gk3s81ulooj311m0u0h2g.jpg",alt:"image-20201027123227994"}})])]),t._v(" "),a("h4",{attrs:{id:"rtmp参数举例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rtmp参数举例"}},[t._v("#")]),t._v(" RTMP参数举例")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("rtmp_app和rtmp_playpath参数（设置推流发布点和流名称）")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("录制命令："),a("code",[t._v("ffmpeg -rtmp_app live -rtmp_playpath class -i rtmp://publish.chinaffmpeg.com -c copy -f flv output.flv")])])]),t._v(" "),a("li",[a("p",[t._v("发布命令："),a("code",[t._v("ffmpeg -re -i input.mp4 -c copy -f flv -rtmp_app live -rtmp_playpath class rtmp://publish.chinaffmpeg.com")])])]),t._v(" "),a("li",[a("p",[t._v("等价的简洁命令："),a("code",[t._v("ffmpeg -i input.mp4 -c copy -f flv rtmp://publish.chinaffmeg.com/live/class")])])])])]),t._v(" "),a("li",[a("p",[t._v("rtmp_pageurl参数（在RTMP服务器中可以根据这个消息进行referer防盗链操作）")]),t._v(" "),a("ul",[a("li",[a("p",[a("code",[t._v('-rtmp_pageurl "http://www.chinaffmpeg.com"')])])]),t._v(" "),a("li",[a("p",[t._v("同理还有swfUrl和tcUrl参数，具体可以看文档了解")])])])])]),t._v(" "),a("h2",{attrs:{id:"ffmpeg录制rtsp流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg录制rtsp流"}},[t._v("#")]),t._v(" FFmpeg录制RTSP流")]),t._v(" "),a("ul",[a("li",[t._v("RTSP曾经是主流直播方式，互联网已大多转向RTMP、HTTP+FLV、HLS、DASH等方式，但RTSP在安防领域仍常见")]),t._v(" "),a("li",[t._v("使用RTSP拉流时，常因采用UDP方式导致丢包异常，所以在实时性与可靠性适中时，考虑采用TCP方式拉流")])]),t._v(" "),a("h4",{attrs:{id:"rtsp参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rtsp参数说明"}},[t._v("#")]),t._v(" RTSP参数说明")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/0081Kckwly1gk3slstmmbj311o0t2qf3.jpg",alt:"image-20201027124539872"}})])]),t._v(" "),a("h4",{attrs:{id:"rtsp参数使用举例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rtsp参数使用举例"}},[t._v("#")]),t._v(" RTSP参数使用举例")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("TCP方式录制RTSP直播流："),a("code",[t._v("ffmpeg -rtsp_transport tcp -i rtsp://47.90.47.25/test.ts -c copy -f mp4 output.mp4")])])]),t._v(" "),a("li",[a("p",[t._v("User-Agent设置参数（服务器端区分是否自己访问）："),a("code",[t._v('-user-agent "ChinaFFmpeg-Player"')])])])]),t._v(" "),a("h2",{attrs:{id:"ffmpeg录制http流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg录制http流"}},[t._v("#")]),t._v(" FFmpeg录制HTTP流")]),t._v(" "),a("ul",[a("li",[t._v("在流媒体点播中，HTTP服务最为常见，可以使用HTTP传输FLV直播流、TS直播流或M3U8文件等")]),t._v(" "),a("li",[t._v("FFmpeg的HTTP可以作为客户端使用（场景更多、重点说明）、服务端使用")])]),t._v(" "),a("h4",{attrs:{id:"http参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http参数说明"}},[t._v("#")]),t._v(" HTTP参数说明")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/0081Kckwly1gk3svuuumcj310q0ogk2l.jpg",alt:"image-20201027125521653"}})])]),t._v(" "),a("h4",{attrs:{id:"http参数使用举例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http参数使用举例"}},[t._v("#")]),t._v(" HTTP参数使用举例")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("seekable参数（若起始位置不为0，不设定此参数会导致阻塞）：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("ffmpeg -ss 300 -seekable 1 -i http://bbs.chinaffmpeg.com/test.ts -c copy -y output.mp4")])])])]),t._v(" "),a("li",[a("p",[t._v("headers参数")]),t._v(" "),a("ul",[a("li",[t._v("设置referer的例子："),a("code",[t._v('ffmpeg -headers "referer: http://bbs.chinaffmpeg.com/index.html" -i http://play.chinaffmeg.com/live/class.flv -c copy -f flv -y output.flv')])])])]),t._v(" "),a("li",[a("p",[t._v("user_agent参数")]),t._v(" "),a("ul",[a("li",[t._v("FFmpeg连接HTTP时采用的默认User-Agent为"),a("code",[t._v("Lavf")]),t._v("，常见的User-Agent包括FireFox、Chrome、IE以及安卓的StageFright、IOS的QuickTIme等，可自定义设置，如"),a("code",[t._v('-user_agent "lyj"')])])])])]),t._v(" "),a("h4",{attrs:{id:"http拉流录制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#http拉流录制"}},[t._v("#")]),t._v(" HTTP拉流录制")]),t._v(" "),a("ul",[a("li",[t._v("可对HTTP服务器中的流媒体进行录制，还可以转封装，如FLV直播可录制为HLS、MP4、FLV等（编码支持即可）")]),t._v(" "),a("li",[t._v("例子："),a("code",[t._v("ffmpeg -i http://bbs.chinaffmpeg.com/live.ts -c copy -f flv output.flv")])])]),t._v(" "),a("h2",{attrs:{id:"ffmpeg录制和发布udp-tcp流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg录制和发布udp-tcp流"}},[t._v("#")]),t._v(" FFmpeg录制和发布UDP/TCP流")]),t._v(" "),a("ul",[a("li",[t._v("FFmpeg的TCP与UDP传输常见于网络裸传输场景，")])]),t._v(" "),a("h4",{attrs:{id:"tcp与udp参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcp与udp参数说明"}},[t._v("#")]),t._v(" TCP与UDP参数说明")]),t._v(" "),a("ul",[a("li",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/0081Kckwly1gk3ta83d1xj31090u0tj1.jpg",alt:"image-20201027130718186"}})])]),t._v(" "),a("h4",{attrs:{id:"tcp与udp参数使用举例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tcp与udp参数使用举例"}},[t._v("#")]),t._v(" TCP与UDP参数使用举例")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("TCP监听接收流（等待客户端连接本地1234端口）")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("ffmpeg -listen 1 -f flv -i tcp://127.0.0.1:1234/live/stream -c copy -f flv output.flv")])])])]),t._v(" "),a("li",[a("p",[t._v("TCP请求发布流（服务端监听格式和客户端发布格式相同才能正常运行！）")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("ffmpeg -re -i input.mp4 -c copy -f flv tcp://127.0.0.1:1234/live/stream")])])])]),t._v(" "),a("li",[a("p",[t._v("监听端口超时 (5秒内未收到请求则自动退出监听)")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("ffmpeg -listen_timeout 5000 -listen 1 -f flv -i tcp://127.0.0.1:1234/live/stream -c copy -f flv output.flv")])])])]),t._v(" "),a("li",[a("p",[t._v("拉流超时（20秒无数据则退出，解放客户端）")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("ffmpeg -timeout 20000000 -i tcp://192.168.100.179:1935/live/stream -c copy -f flv output.flv")])])])]),t._v(" "),a("li",[a("p",[t._v("TCP传输buffer设置（send_buffer_size/recv_buffer_size 参数；buffer越小，传输越频繁，网络开销越大）")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("ffmpeg -re -i input.mp4 -c copy -send_buffer_size 265 -f flv tcp://192.168.100.179:1234/live/stream")])])])]),t._v(" "),a("li",[a("p",[t._v("绑定本地UDP端口localport（不绑定的话系统默认分配）")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("ffmpeg -re -i input.mp4 -c copy -localport 23456 -f flv udp://192.168.100.179:1234/live/stream")])])])])]),t._v(" "),a("h2",{attrs:{id:"ffmpeg推多路流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg推多路流"}},[t._v("#")]),t._v(" FFmpeg推多路流")]),t._v(" "),a("ul",[a("li",[t._v("编码消耗的资源较转封装多，但很多时候只需要一次转码并且输出多个封装，这就衍生出了需求")])]),t._v(" "),a("h4",{attrs:{id:"管道方式输出多路流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#管道方式输出多路流"}},[t._v("#")]),t._v(" 管道方式输出多路流")]),t._v(" "),a("ul",[a("li",[t._v("系统管道方式\n"),a("ul",[a("li",[a("code",[t._v("ffmpeg -i input -acodec aac -vcodec libx264 -f flv - | ffmpeg -f mpegts -i - -c copy output1 -c copy output2 -c copy output3")])])])])]),t._v(" "),a("h4",{attrs:{id:"tee封装格式输出多路流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tee封装格式输出多路流"}},[t._v("#")]),t._v(" tee封装格式输出多路流")]),t._v(" "),a("ul",[a("li",[t._v("tee封装格式\n"),a("ul",[a("li",[a("code",[t._v('ffmpeg -re -i input.mp4 -vcodec libx264 -acodec aac -map 0 -f tee "[f=flv]rtmp://publish.chinaffmpeg.com/live/stream1 | [f=flv]rtmp:// publish.chinaffmpeg.com/live/stream2"')])])])])]),t._v(" "),a("h4",{attrs:{id:"tee协议输出多路流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tee协议输出多路流"}},[t._v("#")]),t._v(" tee协议输出多路流")]),t._v(" "),a("ul",[a("li",[t._v("tee协议格式(3.1.3版本后支持)\n"),a("ul",[a("li",[a("code",[t._v('ffmpeg -re -i input.mp4 -vcodec libx264 -acodec aac -f flv "tee:rtmp://publish.chinaffmpeg.com/live/stream1|rtmp://publish.chinaffmpeg.com/live/stream2"')])])])])]),t._v(" "),a("h2",{attrs:{id:"ffmpeg生成hds流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg生成hds流"}},[t._v("#")]),t._v(" FFmpeg生成HDS流")]),t._v(" "),a("h4",{attrs:{id:"hds参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hds参数说明"}},[t._v("#")]),t._v(" HDS参数说明")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/0081Kckwly1gk3v6gnieej30yc08s77v.jpg",alt:"image-20201027141445544"}})]),t._v(" "),a("h4",{attrs:{id:"hds使用举例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#hds使用举例"}},[t._v("#")]),t._v(" HDS使用举例")]),t._v(" "),a("ul",[a("li",[t._v("生成output目录中的文件说明")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("output\n-- index.f4m  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("索引文件，主要为F4M参考标准中mainfest相关、Metadata信息等"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n-- stream0.abst （文件流相关描述信息）\n-- stream0Seg1-Frag1 （相似规则文件切片，文件切片中均为mdat信息）\n-- stream0Seg1-Frag2\n")])])]),a("ul",[a("li",[t._v("window_size参数控制文件列表大小（只存4个文件）\n"),a("ul",[a("li",[a("code",[t._v("ffmpeg -re -i input -c copy -f hds -window_size 4 output")])])])]),t._v(" "),a("li",[t._v("extra_window_size参数控制文件列表大小（9个文件）\n"),a("ul",[a("li",[a("code",[t._v("ffmpeg -re -input.mp4 -c copy -f hds -window_size 4 -extra_window_size 5 output")])])])])]),t._v(" "),a("h2",{attrs:{id:"ffmpeg生成dash流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ffmpeg生成dash流"}},[t._v("#")]),t._v(" FFmpeg生成DASH流")]),t._v(" "),a("h4",{attrs:{id:"dash参数说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dash参数说明"}},[t._v("#")]),t._v(" DASH参数说明")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/0081Kckwly1gk3vrgyr8rj30w00gowlh.jpg",alt:"image-20201027143456633"}})]),t._v(" "),a("h4",{attrs:{id:"dash参数使用举例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dash参数使用举例"}},[t._v("#")]),t._v(" DASH参数使用举例")]),t._v(" "),a("ul",[a("li",[t._v("生成文件格式")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("-- index.mpd "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("索引文件"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n-- init-stream0.m4s （初始化信息切片）\n-- init-stream1.m4s\n-- chunk-stream0-00204.m4s （视频切片）\n-- chunk-stream0-00205.m4s\n-- chunk-stream1-00204.m4s （音频切片）\n-- chunk-stream1-00205.m4s\n")])])]),a("ul",[a("li",[t._v("若使用 "),a("code",[t._v("-single_file 1")]),t._v("参数，则得到文件列表如下")])]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("-- index-stream0.m4s\n-- index-stream1.m4s\n-- index.mpd\n")])])])])}),[],!1,null,null,null);e.default=r.exports}}]);